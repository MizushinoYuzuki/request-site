document.addEventListener("DOMContentLoaded", function () {
    // --- Ë®≠ÂÆö„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà ---
    const priceConfig = {
        base: 8000,
        cg: { "1": { price: 5000, text: "3DCG‰∏ÄÈÉ®‰ΩøÁî®" }, "2": { price: 20000, text: "3DCGÂÖ®ÈÉ®‰ΩøÁî®" } },
        p: { "1": { price: 0, text: "ÂêàÂî±‰∫∫Êï∞(1‰∫∫)" }, "2": { price: 2000, text: "ÂêàÂî±‰∫∫Êï∞(2‰∫∫)" }, "3": { price: 4000, text: "ÂêàÂî±‰∫∫Êï∞(3‰∫∫)" }, "4": { price: 6000, text: "ÂêàÂî±‰∫∫Êï∞(4‰∫∫)" }, "5": { price: 8000, text: "ÂêàÂî±‰∫∫Êï∞(5‰∫∫‰ª•‰∏ä)" } },
        d: { "2w": { price: 10000, text: "ÁâπÊÄ•Á¥çÂìÅ(2ÈÄ±Èñì‰ª•ÂÜÖ)" } },
        os: { "st": { price: 15000, text: "MV„Çπ„Çø„Ç§„É´(„Çπ„Éà„Éº„É™„Éº)" }, "ly": { price: 5000, text: "MV„Çπ„Çø„Ç§„É´(„É™„É™„ÉÉ„ÇØ)" } },
        opt: {
            hs: { price: 2000, text: "Á´ã„Å°Áµµ„ÅÆÈ´™Êè∫„Çå" }, nc: { price: 10000, text: "„ÇØ„É¨„Ç∏„ÉÉ„ÉàË®òËºâ„Å™„Åó" }, sb: { price: 0, text: "Áµµ„Ç≥„É≥„ÉÜÊâì„Å°Âêà„Çè„Åõ" },
            ct: { multiplier: 1.5, text: "Ëëó‰ΩúÊ®©Ë≠≤Ê∏°" }, cu: { multiplier: 1.5, text: "ÂïÜÁî®Âà©Áî®" },
            np: { multiplier: 2, text: "„Éù„Éº„Éà„Éï„Ç©„É™„Ç™Êé≤Ëºâ‰∏çÂèØ" }, bd: { isDiscount: true, text: "ÈßÜ„ÅëÂá∫„Åó„ÇØ„É™„Ç®„Ç§„Çø„ÉºÂøúÊè¥ÂÄ§Âºï„Åç" }
        }
    };

    const summaryMap = [
        { label: "„ÅäÂêçÂâç", name: "pn", placeholder: "(Êú™Ë®òÂÖ•)" }, { label: "‰æùÈ†ºÂÜÖÂÆπ", name: "t" },
        { label: "MV„Çπ„Çø„Ç§„É´", name: "cs", condition: (formData) => formData.get('t') === 'c' },
        { label: "MV„Çπ„Çø„Ç§„É´", name: "os", condition: (formData) => formData.get('t') === 'o' },
        { label: "Á¥çÊúü„ÅÆÂ∏åÊúõ", name: "d" }, { label: "3DCG„ÅÆ‰ΩøÁî®", name: "cg" },
        { label: "ÂêàÂî±‰∫∫Êï∞", name: "p", condition: (formData) => { const cs = formData.get('cs'); const os = formData.get('os'); return cs === 'hg' || cs === 'og' || os === 'o-cho'; } },
        { label: "ËøΩÂä†„Ç™„Éó„Ç∑„Éß„É≥", name: "opt", type: 'checkboxGroup' }, { label: "„ÅîÂ∏åÊúõ„ÅÆÈÄ£Áµ°ÊâãÊÆµ", name: "ct" },
        { label: "„Åù„ÅÆ‰ªñ„ÅîË¶ÅÊúõ", name: "msg", placeholder: "(Êú™Ë®òÂÖ•)" }
    ];

    // --- Ë¶ÅÁ¥†„ÅÆÂèñÂæó ---
    const form = document.getElementById("requestForm");
    const allInputs = form.querySelectorAll('select, input[type="checkbox"], textarea');
    const totalDisplay = document.getElementById("totalDisplay");
    const myTypeSelect = document.querySelector('select[name="t"]');
    const contactSelect = document.getElementById("contactSelect");
    const deliverySelect = document.querySelector('select[name="d"]');
    const cgSelect = document.querySelector('select[name="cg"]');
    const deadlineWarning = document.getElementById('deadline-warning');
    const coverStyleSelect = document.querySelector('select[name="cs"]');
    const originalStyleSelect = document.querySelector('select[name="os"]');
    const breakdownContainer = document.getElementById('price-breakdown');
    
    const uiGroups = {
        t: {
            c: [document.getElementById("coverOptions")],
            o: [document.getElementById("originalOptions"), document.getElementById("originalOptions-checkbox")]
        },
        ct: {
            email: [document.getElementById("mailaddress")], x: [document.getElementById("xDM")],
            discord: [document.getElementById("discordDM")], slack: [document.getElementById("slackDM")]
        }
    };

    let lastCalculatedTotal = 0;

    // --- Èñ¢Êï∞ÂÆöÁæ© ---
    function calculate() {
        const formData = new FormData(form);
        const breakdown = { items: [{ text: 'Âü∫Êú¨ÊñôÈáë', price: priceConfig.base }], multipliers: [], hasDiscount: false };
        let total = priceConfig.base;
        let multiplier = 1;
        const addItem = (config, value) => {
            if (config && config[value]) {
                const item = config[value];
                if (typeof item.price === 'number') {
                    total += item.price;
                    breakdown.items.push({ text: item.text, price: item.price });
                }
            }
        };
        addItem(priceConfig.cg, formData.get("cg"));
        addItem(priceConfig.d, formData.get("d"));
        addItem(priceConfig.os, formData.get("os"));
        const coverStyle = formData.get("cs");
        const originalStyle = formData.get("os");
        if (coverStyle === 'hg' || coverStyle === 'og' || originalStyle === 'o-cho') {
            addItem(priceConfig.p, formData.get("p"));
        }
        formData.getAll('opt').forEach(value => {
            const effect = priceConfig.opt[value];
            if (!effect) return;
            addItem(priceConfig.opt, value);
            if (effect.multiplier) {
                multiplier *= effect.multiplier;
                breakdown.multipliers.push(`${effect.text} (x${effect.multiplier})`);
            }
            if (effect.isDiscount) {
                breakdown.hasDiscount = true;
            }
        });
        let finalTotal = total * multiplier;
        let discountAmount = 0;
        if (breakdown.hasDiscount) {
            const discountedTotal = finalTotal / 2;
            const totalAfterFloor = Math.max(discountedTotal, 8000);
            discountAmount = finalTotal - totalAfterFloor;
            finalTotal = totalAfterFloor;
        }
        lastCalculatedTotal = Math.round(finalTotal);
        totalDisplay.textContent = `üßÆ ÂèÇËÄÉÊñôÈáëÔºö¬•${lastCalculatedTotal.toLocaleString()}`;
        
        let breakdownHtml = '<ul>';
        breakdown.items.forEach(item => {
            breakdownHtml += `<li><span class="item-text">${item.text}</span><span class="item-price">¬•${item.price.toLocaleString()}</span></li>`;
        });
        breakdownHtml += '</ul>';
        if (breakdown.multipliers.length > 0) {
            breakdownHtml += `<div class="summary-item">${breakdown.multipliers.join(', ')}</div>`;
        }
        if (discountAmount > 0) {
            breakdownHtml += `<div class="summary-item">${priceConfig.opt.bd.text}: - ¬•${Math.round(discountAmount).toLocaleString()}</div>`;
        }
        const showBreakdown = breakdown.items.length > 1 || breakdown.multipliers.length > 0 || discountAmount > 0;
        breakdownContainer.style.display = showBreakdown ? 'block' : 'none';
        breakdownContainer.innerHTML = breakdownHtml;
    }

    function updateUrlFromState() {
        const params = new URLSearchParams();
        allInputs.forEach(input => {
            const name = input.name;
            if (!name || input.disabled || input.closest('[style*="display: none"]')) return;
            if (input.type === 'checkbox') {
                if (input.checked) params.append(name, input.value);
            } else if (input.value) {
                params.append(name, input.value);
            }
        });
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        history.replaceState({}, '', newUrl);
    }

    function applyStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => {
            const elements = form.elements[key];
            if (!elements) return;
            if (elements.nodeName === 'FIELDSET' || (elements.length && !elements.tagName)) { 
                const values = params.getAll(key);
                Array.from(elements).forEach(el => {
                    if (el.type === 'checkbox') el.checked = values.includes(el.value);
                });
            } else {
                elements.value = value;
            }
        });
        updateDependentUI();
    }

    function toggleVisibility(group, selectedKey) {
        Object.entries(group).forEach(([key, elements]) => {
            elements.forEach(el => {
                if(el) el.style.display = (key === selectedKey) ? 'block' : 'none';
            });
        });
    }

    function updateDependentUI() {
        const selectedType = myTypeSelect.value;
        toggleVisibility(uiGroups.t, selectedType);
        toggleVisibility(uiGroups.ct, contactSelect.value);
        if (selectedType !== 'c') { coverStyleSelect.value = ''; }
        if (selectedType !== 'o') { originalStyleSelect.value = ''; }
        const isCoverChorus = (coverStyleSelect.value === 'hg' || coverStyleSelect.value === 'og');
        const isOriginalChorus = (originalStyleSelect.value === 'o-cho');
        const showChorusCount = isCoverChorus || isOriginalChorus;
        document.getElementById('chorusCountOptions').style.display = showChorusCount ? 'block' : 'none';
        if (!showChorusCount) {
            const chorusSelect = document.querySelector('select[name="p"]');
            if (chorusSelect) chorusSelect.value = '1';
        }
        const isExpress = (deliverySelect.value === '2w');
        cgSelect.disabled = isExpress;
        deadlineWarning.style.display = isExpress ? 'block' : 'none';
        if (isExpress && cgSelect.value !== '0') { cgSelect.value = '0'; }
    }

    function handleFormChange() {
        updateDependentUI();
        calculate();
        updateUrlFromState();
    }
    
    function copyToClipboard(text, message) { navigator.clipboard.writeText(text).then(() => alert(message)).catch(() => alert("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ")); }
    
    function getFullTextFromValue(name, value) {
        if (!value) return null;
        const el = document.querySelector(`select[name="${name}"] option[value="${value}"]`);
        return el ? el.textContent : value;
    }

    function generateFullTextSummary() {
        const formData = new FormData(form);
        const summaryLines = [];
        summaryMap.forEach(item => {
            if (item.condition && !item.condition(formData)) { return; }
            let valueText;
            if (item.type === 'checkboxGroup') {
                const selectedOptions = formData.getAll(item.name);
                if (selectedOptions.length > 0) {
                    valueText = selectedOptions.map(value => 
                        `- ${document.querySelector(`input[name="${item.name}"][value="${value}"]`).parentElement.textContent.trim()}`
                    ).join('\n');
                } else { valueText = '„Å™„Åó'; }
            } else {
                const value = formData.get(item.name);
                valueText = getFullTextFromValue(item.name, value) || item.placeholder || '(Êú™ÈÅ∏Êäû)';
            }
            summaryLines.push(`‚ñ†${item.label}:\n${valueText}`);
        });
        const summary = `„Äê„Åî‰æùÈ†ºÂÜÖÂÆπ„ÅÆ„ÅîÁõ∏Ë´á„Äë\n${summaryLines.join('\n\n')}\n---------------------------------\n‚ñ†ÂèÇËÄÉÊñôÈáë: ¬•${lastCalculatedTotal.toLocaleString()}`;
        return summary.trim();
    }
    
    // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„Å®ÂàùÊúüÂåñ ---
    
    allInputs.forEach(input => input.addEventListener('change', handleFormChange));

    document.getElementById("shareViaEmail").addEventListener('click', () => {
        const recipientEmail = "mirock.works@gmail.com";
        const subject = "„Åî‰æùÈ†ºÂÜÖÂÆπ„ÅÆ„ÅîÁõ∏Ë´á";
        const body = `ÂèÇËÄÉÊñôÈáëÁµêÊûú„Å´„Å™„Çä„Åæ„Åô„ÄÇ\n\n${window.location.href}\nÈáëÈ°ç: ¬•${lastCalculatedTotal.toLocaleString()}\n\n--- „Åî‰æùÈ†ºÊ¶ÇË¶ÅÔºàÊõ≤Âêç„Å™„Å©Ôºâ„Çí„Åì„Å°„Çâ„Å´Êõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ ---\n\n„ÅîÁ¢∫Ë™ç„Çà„Çç„Åó„Åè„ÅäÈ°ò„ÅÑ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ`;
        window.location.href = `mailto:${recipientEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    });

    document.getElementById("shareViaUrl").addEventListener('click', () => copyToClipboard(window.location.href, "„Åì„ÅÆ„Éö„Éº„Ç∏„ÅÆURL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ"));
    document.getElementById("shareViaText").addEventListener('click', () => copyToClipboard(generateFullTextSummary(), "„Åî‰æùÈ†ºÂÜÖÂÆπ„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇ"));
    
    document.getElementById("hamburger").addEventListener("click", function () {
        this.classList.toggle("active");
        document.getElementById("nav-menu").classList.toggle("show");
    });

    // ‚òÖ‚òÖ‚òÖ 1„Å§ÁõÆ„ÅÆ‰øÆÊ≠£ÁÆáÊâÄ ‚òÖ‚òÖ‚òÖ
    document.getElementById('resetButton').addEventListener('click', () => {
        window.location.href = window.location.pathname;
    });

    // ‚òÖ‚òÖ‚òÖ 2„Å§ÁõÆ„ÅÆ‰øÆÊ≠£ÁÆáÊâÄ ‚òÖ‚òÖ‚òÖ
    form.addEventListener('submit', (event) => {
        const isConfirmed = confirm('„Åì„ÅÆÂÜÖÂÆπ„ÅßÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü');
        if (!isConfirmed) { // 'isConfirmd' „Åã„Çâ 'isConfirmed' „Å´‰øÆÊ≠£
            event.preventDefault();
        }
    });

    applyStateFromUrl();
    calculate();
});
